<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>부드럽고 유기적인 이미지맵</title>
    <style>
      #container {
        position: relative;
        display: inline-block;
      }
      img {
        max-width: 100%;
        height: auto;
        display: block;
      }
      svg {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        width: 100%;
        height: 100%;
      }
      area {
        cursor: pointer;
      }
      .highlight.outer {
        fill: none;
        stroke: magenta;
        stroke-width: 8;
        stroke-opacity: 0.3;
        filter: blur(6px);
        stroke-linejoin: round;
        stroke-linecap: round;
      }
      .highlight.inner {
        fill: none;
        stroke: magenta;
        stroke-width: 2;
        filter: blur(1px);
        stroke-linejoin: round;
        stroke-linecap: round;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <img id="main-img" src="static/net.jpg" usemap="#map" alt="이미지맵" />
      <svg id="highlight-svg" xmlns="http://www.w3.org/2000/svg"></svg>
    </div>

    <map name="map" id="img-map"></map>

    <script>
      const jsonFilename = "json/net.json";

      const hardcodedRects = [
        { coords: [400, 1120, 600, 1160], href: "link_rect_1.html", alt: "넷플릭스 시리즈" },
        { coords: [320, 1355, 540, 1420], href: "https://www.netflix.com/kr/", alt: "NetFlix" },
        { coords: [180, 1175, 820, 1325], href: "link_rect_3.html", alt: "폭삭 속았수다" },
      ];

      function catmullRomToBezier(points) {
        const d = [];
        for (let i = 0; i < points.length - 2; i += 2) {
          const p0 = i === 0 ? [points[i], points[i + 1]] : [points[i - 2], points[i - 1]];
          const p1 = [points[i], points[i + 1]];
          const p2 = [points[i + 2], points[i + 3]];
          const p3 = i + 4 < points.length ? [points[i + 4], points[i + 5]] : p2;

          const cp1x = p1[0] + (p2[0] - p0[0]) / 6;
          const cp1y = p1[1] + (p2[1] - p0[1]) / 6;
          const cp2x = p2[0] - (p3[0] - p1[0]) / 6;
          const cp2y = p2[1] - (p3[1] - p1[1]) / 6;

          d.push([cp1x, cp1y, cp2x, cp2y, p2[0], p2[1]]);
        }
        return d;
      }

      function getSmoothPath(points) {
        if (points.length < 6) return `M${points[0]},${points[1]} L${points.slice(2).join(",")} Z`;

        let d = `M${points[0]},${points[1]}`;
        const beziers = catmullRomToBezier(points);

        for (const [cp1x, cp1y, cp2x, cp2y, x, y] of beziers) {
          d += ` C${cp1x},${cp1y} ${cp2x},${cp2y} ${x},${y}`;
        }
        d += " Z";
        return d;
      }

      fetch(jsonFilename)
        .then((res) => res.json())
        .then((data) => {
          const img = document.getElementById("main-img");
          const map = document.getElementById("img-map");
          const svg = document.getElementById("highlight-svg");

          function getSize() {
            return { w: img.clientWidth, h: img.clientHeight };
          }

          function clearHighlight() {
            while (svg.firstChild) svg.removeChild(svg.firstChild);
          }

          function drawHighlight(coords, shape) {
            clearHighlight();
            if (!coords.length) return;

            if (shape === "rect") {
              const [x1, y1, x2, y2] = coords;
              const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
              rect.setAttribute("x", x1);
              rect.setAttribute("y", y1);
              rect.setAttribute("width", x2 - x1);
              rect.setAttribute("height", y2 - y1);
              rect.setAttribute("class", "highlight inner");
              svg.appendChild(rect);
            } else if (shape === "poly" || shape === "polygon") {
              const d = getSmoothPath(coords);
              const outer = document.createElementNS("http://www.w3.org/2000/svg", "path");
              outer.setAttribute("d", d);
              outer.setAttribute("class", "highlight outer");

              const inner = document.createElementNS("http://www.w3.org/2000/svg", "path");
              inner.setAttribute("d", d);
              inner.setAttribute("class", "highlight inner");

              svg.appendChild(outer);
              svg.appendChild(inner);
            }
          }

          function renderMap() {
            map.innerHTML = "";
            clearHighlight();

            const { w, h } = getSize();

            data.forEach((polygon) => {
              const coords = polygon.coords.split(",").map(parseFloat);
              const absCoords = coords.map((val, i) => (i % 2 === 0 ? Math.round(val * w) : Math.round(val * h)));

              const area = document.createElement("area");
              area.shape = polygon.shape || "poly";
              area.coords = absCoords.join(",");
              area.href = polygon.href || "#";
              area.alt = polygon.label || "폴리곤 영역";
              area.target = "_blank";

              area.addEventListener("mouseenter", () => {
                drawHighlight(absCoords, area.shape);
              });
              area.addEventListener("mouseleave", clearHighlight);

              map.appendChild(area);
            });

            hardcodedRects.forEach(({ coords, href, alt }) => {
              const area = document.createElement("area");
              area.shape = "rect";
              area.coords = coords.join(",");
              area.href = href;
              area.alt = alt;
              area.target = "_blank";

              area.addEventListener("mouseenter", () => {
                drawHighlight(coords, "rect");
              });
              area.addEventListener("mouseleave", clearHighlight);

              map.appendChild(area);
            });
          }

          img.onload = renderMap;
          if (img.complete) renderMap();
          window.addEventListener("resize", renderMap);
        })
        .catch((err) => console.error("JSON 로드 실패:", err));
    </script>
  </body>
</html>
